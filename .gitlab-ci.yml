default:
  image: "archlinux:latest"

variables:
  PACKER_LOG: 1

stages:
  - lint
  - build
  - publish

shellcheck:
  stage: lint
  before_script:
    - pacman -Syu --needed --noconfirm shellcheck
  script:
    - find . -iname "*.sh" -exec shellcheck {} +

shfmt:
  stage: lint
  before_script:
    - pacman -Syu --needed --noconfirm shfmt
  script:
    - find . -iname "*.sh" -exec shfmt -i 2 -ci -d {} +

validate-packer:
  stage: lint
  before_script:
    - pacman -Syu --needed --noconfirm packer
  script:
    - packer validate -var "iso_checksum_url=https://mirror.pkgbuild.com/iso/latest/sha1sums.txt" -except=publish vagrant.json
    - packer validate cloud.json

# Note: We explicitly need the `ipv6` tag here because otherwise we'd get random
# gpg/pacman-key issues.
build:cloud-qemu:
  stage: build
  tags:
    - ipv6
  before_script:
    - pacman -Syu --needed --noconfirm packer qemu-headless
  script:
    - packer build -except=sign cloud.json
  artifacts:
    name: "archlinux_x86_64_qcow2"
    paths:
      - "Arch-Linux-x86_64-cloudimg-*.*"
    expire_in: 2d

build:vagrant-virtualbox:
  stage: build
  tags:
    - ipv6
  before_script:
    - pacman -Syu --needed --noconfirm packer qemu-headless
  script:
    - packer build -only=virtualbox -except publish vagrant.json

build:vagrant-qemu:
  stage: build
  tags:
    - ipv6
  before_script:
    - pacman -Syu --needed --noconfirm packer qemu-headless
  script:
    - packer build -only=libvirt -except publish vagrant.json

publish:
  stage: publish
  tags:
    - ipv6
    - secure
  before_script:
    - pacman -Syu --needed --noconfirm qemu-headless packer
  script:
    - packer build -var "vagrant_cloud_token=$VAGRANT_API_TOKEN" vagrant.json
  only:
    variables:
      - $SCHEDULED_PUBLISH == "TRUE"
  resource_group: vm-build
